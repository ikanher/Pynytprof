FILE_FORMAT.md ── NYTProf v5.0 stream as written by **Pynytprof**

Scope
-----
We emit the minimal byte stream that Perl’s `Devel::NYTProf::Reader`
(v5.0) accepts.  Everything is little-endian.  No compression yet.

───────────────────────────────────────────────────────────────────────
1.  ASCII header (human-readable, newline-terminated)
───────────────────────────────────────────────────────────────────────

The file always starts with **exactly three ASCII lines**, followed by
a list of colon-prefixed key/value lines.  All end in `\n`:

    NYTProf <major> <minor>\n
    #Perl profile database. Generated by Pynytprof on <RFC-2822 date>\n
    :basetime=<epoch-seconds>\n
    :application=-e\n
    :perl_version=<py_major.minor.patch>\n
    :nv_size=<sizeof(double) bytes>\n
    :clock_mod=cpu\n
    :ticks_per_sec=10000000\n
    :osname=<lower-case platform.system()>\n
    :hz=<sysconf(_SC_CLK_TCK) or 100>\n

**Termination rule**: the header ends at the first byte that is not a
printable ASCII character nor `\n`.  Pynytprof immediately starts the
binary chunk stream after writing the final `\n`.


───────────────────────────────────────────────────────────────────────
2.  Chunk stream
───────────────────────────────────────────────────────────────────────

Binary data follows a tag–length–value pattern:

    u8  token        (ASCII letter)
    u32 length_le    (payload size, little-endian)
    <payload bytes>

Mandatory chunks for MVP
------------------------

| Token | Payload struct                                                    | Notes                                      |
|-------|-------------------------------------------------------------------|--------------------------------------------|
| `A`   | NUL-joined `key=value` strings                                    | Must repeat `ticks_per_sec` & `start_time` |
| `F`   | `{u32 fid,u32 flags,u32 size,u32 mtime,zstr path}` × N            | Script = fid 0, set `flags |= 0x10` (HAS_SRC) |
| `S`   | repeat `{u32 fid,u32 line,u32 calls,u64 inc_ticks,u64 exc_ticks}` | at least one record per executed line |
| `C`   | Call-graph edge records (same layout as NYTProf)                  | Optional but improves `nytprofhtml` output |
| `D`   | Subroutine descriptors                                            | Optional                                   |
| `E`   | **empty**                                                         | Terminator                                 |

Chunk tokens `H`/`B` (legacy ASCII/binary header) are **not used**.


───────────────────────────────────────────────────────────────────────
3.  Tick units
───────────────────────────────────────────────────────────────────────

We adopt NYTProf’s canonical value  
`ticks_per_sec = 10_000_000` (100 ns).  Keep all tick arithmetic in
64-bit to avoid overflow on long runs.


───────────────────────────────────────────────────────────────────────
4.  Endianness
───────────────────────────────────────────────────────────────────────

Always little-endian.  Big-endian files are rejected by NYTProf.


───────────────────────────────────────────────────────────────────────
5.  Version constants
───────────────────────────────────────────────────────────────────────

Both C and Python writers include `nytp_version.h`:

    #define NYTPROF_MAJOR 5
    #define NYTPROF_MINOR 0

Bump **both** docs and code together when the format evolves.


───────────────────────────────────────────────────────────────────────
6.  Reference dump
───────────────────────────────────────────────────────────────────────

`vendor/NYTProf_refs/sample_nytprof.out.xxd` is the canonical output
generated by Pynytprof on 2025-07-07.  Your changes must produce a file
whose first 64 bytes match the reference, except for dynamic fields
(`basetime`, date string, etc.).

----------------------------------------------------------------------
