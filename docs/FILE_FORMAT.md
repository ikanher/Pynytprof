FILE_FORMAT.md — NYTProf v5.0 stream as written by **Pynytprof**

Scope
-----
Pynytprof emits profiles in the uncompressed NYTProf v5.0 format that Perl’s
Devel::NYTProf::Reader (v5.0) will load. Little-endian only; zlib compression
is not applied here.

──────────────────────────────────────────────────────────────────────
1.  ASCII banner (human-readable, newline-terminated)
──────────────────────────────────────────────────────────────────────

The file starts with free-text lines, each ending in `\n`:

    NYTProf <major> <minor>\n
    # Perl profile database. Generated by Pynytprof on <RFC-2822 date>\n

Then *attribute* lines (start with `:`) one per line:

    :basetime=<epoch-seconds>\n
    :application=<argv0 or -e>\n
    :perl_version=<py_major.minor.patch>\n
    :nv_size=<sizeof(double) bytes>\n
    :clock_mod=cpu\n
    :ticks_per_sec=10000000\n
    :osname=<platform.system().lower()>\n
    :hz=<os.sysconf("SC_CLK_TCK") or 100>\n

Followed by *option* lines (start with `!`) mirroring NYTProf defaults:

    !subs=1
    !blocks=0
    !leave=1
    !expand=0
    !trace=0
    !use_db_sub=0
    !compress=0
    !clock=1
    !stmts=1
    !slowops=2
    !findcaller=0
    !forkdepth=-1
    !perldb=0
    !nameevals=1
    !nameanonsubs=1
    !calls=1
    !evals=0

The banner **always ends with a blank line** (`\n\n`). The very first byte
after that blank line is the token for the first binary record.

──────────────────────────────────────────────────────────────────────
2.  Binary record stream
──────────────────────────────────────────────────────────────────────

Each record is a *tag* (ASCII letter) followed by a little-endian 32-bit
length, then the payload:

    u8   token       (ASCII letter)
    u32  length_le   (payload size)
    ...  payload     (exactly *length* bytes)

**Order of records**:
  1. `P` — process-start (required)
  2. `S` — subs
  3. `D` — sub-descriptors
  4. `C` — call-graph edges
  5. `E` — terminator (empty)

| Token | Payload struct                                                            | Notes                                               |
|-------|----------------------------------------------------------------------------|-----------------------------------------------------|
| `P`   | `{u64 start_time_us, u32 pid, u32 ppid}`                                  | Records process start time and PIDs.               |
| `S`   | `{u32 fid, u32 line, u32 calls, u64 inc_ticks, u64 exc_ticks}` × M       | One per executed line; ticks in 100 ns units.      |
| `D`   | `{u32 sid, u32 flags, zstr name}` × K                                    | Subroutine descriptors; flags = 0 for now.         |
| `C`   | `{u32 caller_sid, u32 callee_sid, u32 calls, u64 ticks, u64 sub_ticks}` × L | Call-graph edges.                               |
| `E`   | *empty*                                                                   | Terminator.                                         |

Tokens `F`, `B`, and `A` are **not emitted** by the ASCII-banner writer.

──────────────────────────────────────────────────────────────────────
3.  Tick units
──────────────────────────────────────────────────────────────────────

One tick = 100 ns. `ticks_per_sec` is fixed at 10,000,000. All tick arithmetic
uses 64-bit integers.

──────────────────────────────────────────────────────────────────────
4.  Endianness
──────────────────────────────────────────────────────────────────────

Entire stream is little-endian. NYTProf rejects big-endian files.

──────────────────────────────────────────────────────────────────────
5.  Version constants
──────────────────────────────────────────────────────────────────────

Defined in `nytp_version.h` and used by both writers:

    #define NYTPROF_MAJOR 5
    #define NYTPROF_MINOR 0

Docs and code must be updated together if these change.

──────────────────────────────────────────────────────────────────────
6.  Reference dump
──────────────────────────────────────────────────────────────────────

`vendor/NYTProf_refs/sample_nytprof.out.uncompressed.xxd-dump.txt` is the
golden uncompressed profile taken on 2025-07-09. A new profile’s first
64 bytes (after date-dependent fields) must match this dump exactly.

──────────────────────────────────────────────────────────────────────
7.  Perl XS profile reading and header writing functions
──────────────────────────────────────────────────────────────────────

`vendor/NYTProf_refs/NYTProf.xs` contains a stripped down version of
`NYTProf.xs` that for now contains only the functions for reading a
profile dump and outputting a hader.

-----------------------------------------------------------------------
